<!doctype html>
<html lang="en">

<head>
	<!-- Required meta tags -->
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

	<!-- Bootstrap CSS -->
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

	<title>Seconds testing tool</title>

	<style>
		div {
			text-align: center;
		}

		.row {
			margin: 1em;
		}

		.container.file-upload {
			max-width: 400px;
			display: block;
		}

		.container.browser {
			display: block;
		}

		.cont-exercises {
			display: flex;
			height: 5rem;
			overflow: hidden;
			font-size: .8rem;
			color: white;
			background-color: #cfdfef;
			border-radius: 0;
			margin-top: 2px;
		}

		.exercise {
			margin: 1px;
			background-color: #2196f3;
			/* 166 213 250 */
		}

		.intro {
			background-color: #424242;
		}

		.outro {
			background-color: #424242;
		}

		.rest {
			background-color: #673ab7;
		}

		.exer-icon {
			display: block;
			text-align: right;
		}

		.exer-name {
			display: block;
			margin-top: 1rem;
		}

		.card {
			margin-left: 15px;
			margin-right: 15px;
			width: 100%;
		}

		.card-footer {
			text-align: right;
		}

		#btn-save-all {
			width: 40%;
			max-width: 300px;
			min-width: 100px;
		}

		.vertical-line {
			border-left: 1px solid black;
			width: 1px;
		}

		.horizontal-line {
			border-top: 1px solid black;
			height: 1px;
			margin-left: 15px;
			margin-right: 15px;
		}

		.progress{
			text-align: right;
		}

		#audio-duration {
			font-size: .75rem;
			margin: 0;
			padding: 0;
		}

		p {
			margin: auto;
		}
	</style>
</head>

<body>
	<!--                     Upload File                     -->
	<div id="cont-file-upload" class="container file-upload">
		<div class="row">
			<button type="button" id="btn-builder" class="btn btn-primary form-control">Builder</button>
		</div>
		<div class="horizontal-line"></div>
		<div class="row">
			<input type="file" id="csv-upload" class="form-control-file" accept="csv">
		</div>
		<div class="row">
			<select id="opt-workout" class="form-control">
			</select>
		</div>
		<div class="row">
			<button type="button" id="btn-process" class="btn btn-primary form-control">Process File</button>
		</div>
	</div>
	<!--                     Browser                     -->
	<div id="cont-browser" class="container" style="display: none;">
		<div class="row">
			<div class="col-sm">
				<button type="button" id="btn-previous" class="btn btn-outline-primary">Previous</button>
			</div>
			<div class="col-sm">
				<h4 id="workout-id">Workout ID</h4>
				<h4 id="workout-name">Workout Name</h4>
			</div>
			<div class="col-sm">
				<button type="button" id="btn-next" class="btn btn-outline-primary">Next</button>
			</div>
		</div>
		<div class="row btn-group" role="group">
			<button type="button" id="btn-back10s" class="btn btn-outline-dark">Back 10s</button>
			<button type="button" id="btn-play" class="btn btn-outline-dark">Play</button>
			<button type="button" id="btn-pause" class="btn btn-outline-dark">Pause</button>
			<button type="button" id="btn-forward10s" class="btn btn-outline-dark">Forward 10s</button>
		</div>
		<div class="row">
			<div class="col-8">
				<h4 id="cur-playback">Current playback second</h4>
				<div class="row">
					<div class="col">
						<div class="progress justify-content-between">
							<div id="progress-bar" class="progress-bar" role="progressbar" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div>
						</div>
						<div id="cont-exercises" class="cont-exercises">
							<div class="exercise intro" style="width: 20%">
								<span class="exer-icon">&#x1f5d1;</span>
								<span class="exer-name">Intro</span>
							</div>
							<div class="exercise" style="width: 20%">
								<span class="exer-icon">&#x1f5d1;</span>
								<span class="exer-name">Exercise 1</span>
							</div>
							<div class="exercise rest" style="width: 20%">
								<span class="exer-icon">&#x1f5d1;</span>
								<span class="exer-name">Rest</span>
							</div>
							<div class="exercise" style="width: 20%">
								<span class="exer-icon">&#x1f5d1;</span>
								<span class="exer-name">Exercise 2</span>
							</div>
							<div class="exercise outro" style="width: 20%">
								<span class="exer-icon">&#x1f5d1;</span>
								<span class="exer-name">Outro</span>
							</div>
						</div>
					</div>
					<span id="audio-duration" class="col-md-auto">00:00</span>
				</div>
			</div>
			<div class="col-4">
				Add new
				<div class="btn-group" role="group">
					<button type="button" id="btn-add-exercise" class="btn btn-outline-dark">Exercise</button>
					<button type="button" id="btn-add-rest" class="btn btn-outline-dark">Rest</button>
					<button type="button" id="btn-add-intro" class="btn btn-outline-dark">Intro</button>
					<button type="button" id="btn-add-outro" class="btn btn-outline-dark">Outro</button>
				</div>
			</div>
		</div>
		<div class="row">
			<div class="card">
				<div class="card-header">
					<h4 style="text-align: left;">Exercise 3</h4>
				</div>
				<div class="card-body row">
					<div class="col-6">
						<select id="opt-exercises" class="form-control">
							<option>exercise 1</option>
							<option>exercise 2</option>
						</select>
						<button type="button" id="btn-save" class="btn btn-success" style="width: 100%; margin-top: 1rem">Match</button>
					</div>
					<div class="vertical-line"></div>
					<div class="col-sm" style="text-align: left;">
						<p>Start time</p>
						<input type="number" id="input-start-time" class="form-control" />
						<p>Duration</p>
						<input type="number" id="input-duration" class="form-control" />
						<p>End time</p>
						<input type="number" id="input-end-time" class="form-control" />
					</div>
				</div>
				<div class="card-footer">
					<button type="button" id="btn-save" class="btn btn-primary">Save Changes</button>
				</div>
			</div>
		</div>
		<button type="button" id="btn-save-all" class="btn btn-primary">Save all Changes</button>
	</div>
	<script>
		let btn_process = document.getElementById("btn-process");
		let input_csv = document.getElementById("csv-upload");
		let opt_workout = document.getElementById("opt-workout");
		let progressbar = document.getElementById("progress-bar");
		let elem_cur_time = document.getElementById("cur-playback");
		let cont_exercises = document.getElementById("cont-exercises");
		let cont_file_upload = document.getElementById("cont-file-upload");
		let cont_browser = document.getElementById("cont-browser");
		let elem_workout_id = document.getElementById("workout-id");
		let elem_workout_name = document.getElementById("workout-name");
		let btn_back10 = document.getElementById("btn-back10s");
		let btn_play = document.getElementById("btn-play");
		let btn_forward10 = document.getElementById("btn-forward10s");
		let btn_pause = document.getElementById("btn-pause");
		let opt_exercises = document.getElementById("opt-exercises");

		let audio;
		let workouts = []; // id, name, mp3, live_data
		let intervals = [];	// type, name, duration, start, end
		let exercises = []; // name, id
		let selectedWorkout = -1;
		let dur_audio = 0, cur_time = 0;
		input_csv.onchange = () => {
			opt_workout.length = 0;
			workouts = [];
			if (input_csv.files.length <= 0) {
				return;
			}
			let fileReader = new FileReader();
			fileReader.readAsText(input_csv.files[0]);
			fileReader.onload = () => {
				let res = fileReader.result.split("\n");
				for (i = 1; i < res.length; i++) {
					let res1 = res[i].split(",");
					workouts.push({
						id: res1[0],
						name: res1[1],
						mp3: res1[2],
						live_data: res1[3]
					});
					let opt = document.createElement("option");
					opt.text = res1[1];
					opt_workout.add(opt);
				}
			}
		}
		let xHttpCSV = new XMLHttpRequest();
		xHttpCSV.open("GET", "Workouts 1.0-Grid view - Exercises.csv", true);
		opt_exercises.innerHTML = "";
		xHttpCSV.addEventListener("load", () => {
			if (xHttpCSV.readyState == 4 && xHttpCSV.status == 200) {
				let res = xHttpCSV.responseText.split("\n");
				for (i = 1; i < res.length; i ++) {
					let res1 = res[i].split(",");
					exercises.push({
						name: res1[0],
						id: res1[1]
					});
					let opt = document.createElement("option");
					opt.text = res1[0];
					opt_exercises.add(opt);
				}
			}
		});
		xHttpCSV.send(null)
		btn_process.onclick = event => {
			selectedIndex = opt_workout.selectedIndex;
			if (selectedIndex < 0) {
				return;
			}
			cont_file_upload.style.display = "none";
			cont_browser.style.display = "block";

			elem_workout_id.innerText = workouts[selectedIndex].id;
			elem_workout_name.innerText = workouts[selectedIndex].name;



			audio = new Audio(workouts[selectedIndex].mp3);
			audio.addEventListener("loadeddata", () => {
				dur_audio = parseInt(audio.duration);
				document.getElementById("audio-duration").innerText = ("00" + parseInt(dur_audio / 60).toString()).slice(-2)
				 + ":" + ("00" + parseInt(dur_audio % 60).toString()).slice(-2);
				audio.play()
				cur_time = 0;
				progressbar.style.width = "0%";

				intervals = [];
				let xHttp = new XMLHttpRequest();
				xHttp.open("GET", workouts[selectedIndex].live_data, true);
				xHttp.addEventListener("load", () => {
					if (xHttp.readyState == 4 && xHttp.status == 200) {
						intervals = JSON.parse(xHttp.responseText).intervals;
						console.log(intervals)
						cont_exercises.innerHTML = "";
						let temp = 0;
						for (let i = 0; i < intervals.length; i ++) {
							intervals[i].start_time = temp;
							temp += intervals[i].duration;
							if (temp > dur_audio) {
								intervals.length = i;
								break;
							}
							intervals[i].end_time = temp;
							let elem_interval = document.createElement("div");
							elem_interval.classList = ["exercise"];
							// elem_interval.classList.add("intro");
							elem_interval.style.width = (intervals[i].duration / dur_audio * 100) + "%";
							console.log(elem_interval.style.width)
							let elem_icon = document.createElement("span");
							elem_icon.className = "exer-icon";
							elem_icon.innerHTML = "&#x1f5d1;";
							let elem_name = document.createElement("span");
							elem_name.className = "exer-name";
							elem_name.innerHTML = intervals[i].name;
							elem_interval.appendChild(elem_icon);
							elem_interval.appendChild(elem_name);
							cont_exercises.appendChild(elem_interval);
						}
					}
				})
				xHttp.send(null);
			});
			audio.addEventListener("timeupdate", () => {
				cur_time = audio.currentTime;
				elem_cur_time.innerText = ("00" + parseInt(cur_time / 60).toString()).slice(-2)
				 + ":" + ("00" + parseInt(cur_time % 60).toString()).slice(-2);
				progressbar.style.width = (100 * cur_time / dur_audio) + "%";
			});
			btn_play.addEventListener("click", () => {
				audio.play();
			});
			btn_pause.addEventListener("click", () => {
				audio.pause();
			});
			btn_back10.addEventListener("click", () => {
				cur_time -= 10;
				cur_time = Math.max(cur_time, 0);
				audio.currentTime = cur_time;
			});
			btn_forward10.addEventListener("click", () => {
				cur_time += 10;
				cur_time = Math.min(cur_time, dur_audio);
				audio.currentTime = cur_time;
			});
		}
	</script>
	<!-- jQuery first, then Popper.js, then Bootstrap JS -->
	<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
</body>

</html>